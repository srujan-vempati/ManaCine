{% extends "base.html" %}
{% block content %}
<style>
    .profile-header {
        position: relative;
        margin-bottom: 30px;
    }

    .profile-banner {
        position: relative;
        height: 50vh;
        max-height: 400px;
        min-height: 300px;
        background-size: cover;
        background-position: center;
        margin: 0 -20px;
    }

    .banner-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(18, 18, 18, 0.3) 0%, rgba(18, 18, 18, 0.8) 70%, var(--bg) 100%);
    }

    .profile-info {
        max-width: 1100px;
        margin: -120px auto 0;
        padding: 0 20px;
        position: relative;
        z-index: 10;
        display: flex;
        align-items: flex-end;
        gap: 30px;
    }

    .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 4px solid var(--bg);
        overflow: hidden;
        background: #000;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        flex-shrink: 0;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-names {
        flex: 1;
    }

    .profile-names h2 {
        margin: 0 0 5px 0;
        color: var(--text-main);
        line-height: 1.2;
        font-size: 2.5rem;
        font-weight: 800;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
    }

    .profile-names p {
        margin: 0;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.1rem;
    }

    .stats-bar {
        background: var(--surface);
        padding: 15px 30px;
        border-radius: 4px;
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        border: 1px solid var(--border);
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .edit-modal {
        background: var(--surface);
        padding: 20px;
        border-radius: 4px;
        margin-top: 20px;
        border: 1px solid var(--border);
    }

    .section-title {
        color: var(--text-main);
        text-transform: uppercase;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 5px;
        margin: 30px 0 15px;
    }

    /* Mobile Responsive Profile */
    @media (max-width: 768px) {
        .profile-banner {
            height: 200px;
            min-height: 200px;
        }

        .profile-info {
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: -75px;
            gap: 15px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-width: 3px;
        }

        .profile-names h2 {
            font-size: 1.8rem;
        }

        .profile-names p {
            font-size: 1rem;
        }

        /* Stack the main grid */
        .profile-content-grid {
            grid-template-columns: 1fr !important;
            /* Force stack */
            gap: 40px !important;
        }

        .stats-bar {
            padding: 15px;
            gap: 10px;
        }

        .stat-value {
            font-size: 1.2rem;
        }

        .stat-label {
            font-size: 0.7rem;
        }
    }
</style>

<div class="profile-header">
    <div class="profile-banner"
        style="background-image: url('{% if user.profile.banner_url %}{{ user.profile.banner_url }}{% else %}https://via.placeholder.com/1920x400/2c3440/2c3440{% endif %}');">
        <div class="banner-overlay"></div>
    </div>

    <div class="profile-info">
        <div class="profile-avatar">
            <img src="{{ user.profile.avatar.url }}" alt="Avatar">
        </div>
        <div class="profile-names">
            <h2>{{ user.username }}</h2>
            <p>{{ user.profile.bio|default:"No bio yet." }}</p>
        </div>
        <div style="margin-bottom: 5px;">
            <!-- Toggle Edit Form -->
            <button onclick="document.getElementById('edit-form').style.display='block'" class="btn"
                style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); font-size:0.8rem; backdrop-filter: blur(10px);">Edit
                Profile</button>
        </div>
    </div>
</div>

<div class="stats-bar">
    <div class="stat-item">
        <span class="stat-value">{{ reviews_count }}</span>
        <span class="stat-label">Watched</span>
    </div>
    <div class="stat-item">
        <span class="stat-value">{{ favorites_count }}</span>
        <span class="stat-label">Favorites</span>
    </div>
    <div class="stat-item">
        <span class="stat-value">0</span>
        <span class="stat-label">Lists</span>
    </div>
</div>

<div id="edit-form" class="edit-modal" style="display: none;">
    <div class="edit-modal-content">
        <h3
            style="color: #fff; margin-top: 0; border-bottom:1px solid var(--glass-border); padding-bottom:15px; margin-bottom:20px;">
            Edit Profile</h3>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-group">
                <label style="color: var(--text-secondary); margin-bottom: 8px; display:block;">Bio</label>
                {{ p_form.bio }}
            </div>

            <div class="form-group">
                <label style="color: var(--text-secondary); margin-bottom: 8px; display:block;">Avatar</label>
                <div class="file-upload-wrapper">
                    {{ p_form.avatar }}
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px; justify-content: flex-end;">
                <button type="button" class="btn"
                    style="background: transparent; border: 1px solid var(--glass-border); color: #ccc;"
                    onclick="document.getElementById('edit-form').style.display='none'">Cancel</button>
                <button class="btn btn-primary" type="submit">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Premium Edit Modal */
    .edit-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: flex;
        /* Hidden by inline style initially */
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s ease;
    }

    .edit-modal-content {
        background: #1e2025;
        width: 100%;
        max-width: 500px;
        padding: 30px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUpModal {
        from {
            transform: translateY(30px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Form Styling overrides */
    #id_bio {
        width: 100%;
        background: #141619;
        border: 1px solid #333;
        color: #fff;
        padding: 12px;
        border-radius: 8px;
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    #id_bio:focus {
        outline: none;
        border-color: var(--primary);
        background: #1a1d21;
    }

    /* File Input Styling */
    input[type="file"] {
        background: #141619;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #333;
        width: 100%;
        color: #aaa;
        cursor: pointer;
    }

    input[type="file"]::file-selector-button {
        background: var(--surface);
        color: #fff;
        border: 1px solid var(--glass-border);
        padding: 5px 10px;
        border-radius: 4px;
        margin-right: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }

    input[type="file"]::file-selector-button:hover {
        background: rgba(255, 255, 255, 0.1);
    }
</style>

<div class="profile-content-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
    <div>
        <h3 class="section-title">Favorite Movies</h3>
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">
            {% for fav in favorites %}
            <div style="min-width: 100px; width: 100px; flex-shrink: 0;">
                <a href="{% url 'movie-detail' fav.movie_id %}">
                    {% if fav.poster_url %}
                    <img src="{{ fav.poster_url }}" alt="Poster"
                        style="width: 100%; border-radius: 4px; border: 1px solid #456;">
                    {% else %}
                    <div
                        style="width: 100%; height: 150px; background: #333; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #456;">
                        <span style="font-size:0.7rem; color: #777;">#{{ fav.movie_id }}</span>
                    </div>
                    {% endif %}
                </a>
            </div>
            {% empty %}
            <p style="color: #678;">No favorites yet.</p>
            {% endfor %}
        </div>

        <h3 class="section-title">Recently Watched</h3>
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">
            {% for vid in watched_movies %}
            <div style="min-width: 100px; width: 100px; flex-shrink: 0;">
                <a href="{% url 'movie-detail' vid.movie_id %}">
                    {% if vid.poster_url %}
                    <img src="{{ vid.poster_url }}" alt="Poster"
                        style="width: 100%; border-radius: 4px; border: 1px solid #456;">
                    {% else %}
                    <div
                        style="width: 100%; height: 150px; background: #333; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid #456;">
                        <span style="font-size:0.7rem; color: #777;">watched</span>
                    </div>
                    {% endif %}
                </a>
            </div>
            {% empty %}
            <p style="color: #678;">No watched movies yet.</p>
            {% endfor %}
        </div>

        <h3 class="section-title">Recent Reviews</h3>
        <div>
            {% for review in recent_reviews %}
            <div style="border-bottom: 1px solid #333; padding: 15px 0; display: flex; gap: 15px;">
                <!-- Review Content -->
                <div style="width: 100%;">
                    <div style="font-weight: 600; color: #fff; margin-bottom: 5px;">
                        <span style="color: #00e054;">â˜… {{ review.rating }}</span> on Movie #{{ review.movie_id }}
                    </div>
                    <p style="color: #bcc; margin: 0; font-size: 0.9rem;">{{ review.content }}</p>
                    <small style="color: #567;">{{ review.created_at|date:"M d, Y" }}</small>
                </div>
            </div>
            {% empty %}
            <p style="color: #678;">No reviews yet.</p>
            {% endfor %}
        </div>
    </div>

    <div>
        <h3 class="section-title">Stats</h3>
        <div style="text-align: center; color: #555; padding: 20px; background: #222; border-radius: 4px;">
            <div style="font-size: 2rem; color: #00e054;">{{ reviews_count }}</div>
            <small>Films Watched</small>
        </div>
    </div>
</div>

{% endblock content %}